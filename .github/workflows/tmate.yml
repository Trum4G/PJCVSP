name: Create Windows VPS

on:
  workflow_dispatch:
    inputs:
      vps_name:
        description: 'T√™n VPS (v√≠ d·ª•: TASTR-Study)'
        required: false
        default: 'TASTR-VPS'
        type: string

      backup:
        description: 'Kh√¥i ph·ª•c t·ª´ backup tr∆∞·ªõc ƒë√≥?'
        required: false
        default: false
        type: boolean
      timeout_minutes:
        description: 'Th·ªùi gian ch·∫°y VPS (ph√∫t, t·ªëi ƒëa 360 = 6 ti·∫øng)'
        required: true
        default: 360
        type: number
      windows_password:
        description: 'M·∫≠t kh·∫©u Windows t√πy ch·ªânh (√≠t nh·∫•t 8 k√Ω t·ª±, b·∫Øt bu·ªôc)'
        required: true
        type: string
      ngrok_token:
        description: 'Ngrok token (b·∫Øt bu·ªôc ƒë·ªÉ k·∫øt n·ªëi ·ªïn ƒë·ªãnh)'
        required: true
        type: string

jobs:
  create-vps:
    runs-on: windows-latest
    timeout-minutes: ${{ fromJSON(inputs.timeout_minutes || '360') }}
    
    steps:
    # Step 1: Validate inputs
    - name: üîç Validate Inputs
      shell: powershell
      run: |
        Write-Host "=== Ki·ªÉm tra ƒë·∫ßu v√†o ===" -ForegroundColor Green
        
        $vpsName = "${{ inputs.vps_name || 'StudyVPS' }}"
        $timeout = [int]"${{ inputs.timeout_minutes || '360' }}"
        
        # Validate VPS name
        if ($vpsName -match '[^a-zA-Z0-9\-_]') {
          Write-Error "T√™n VPS ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë, d·∫•u g·∫°ch ngang v√† g·∫°ch d∆∞·ªõi"
          exit 1
        }
        
        # Validate timeout
        if ($timeout -lt 30 -or $timeout -gt 360) {
          Write-Error "Th·ªùi gian ch·∫°y ph·∫£i t·ª´ 30-360 ph√∫t (t·ªëi ƒëa 6 ti·∫øng)"
          exit 1
        }
        
        # Validate password (now required)
        $customPassword = "${{ inputs.windows_password }}"
        if (-not $customPassword -or $customPassword.Length -lt 8) {
          Write-Error "M·∫≠t kh·∫©u l√† b·∫Øt bu·ªôc v√† ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±"
          exit 1
        }
        
        # Validate ngrok token (now required)
        $ngrokToken = "${{ inputs.ngrok_token }}"
        if (-not $ngrokToken -or $ngrokToken.Length -lt 10) {
          Write-Error "Ngrok token l√† b·∫Øt bu·ªôc v√† ph·∫£i h·ª£p l·ªá"
          exit 1
        }
        
        Write-Host "‚úÖ T·∫•t c·∫£ ƒë·∫ßu v√†o h·ª£p l·ªá" -ForegroundColor Green
        Write-Host "üìù VPS Name: $vpsName" -ForegroundColor Cyan
        Write-Host "üñ•Ô∏è Runner: GitHub Windows (16GB RAM, 200GB SSD, 4 cores)" -ForegroundColor Cyan
        Write-Host "‚è±Ô∏è Timeout: $timeout ph√∫t" -ForegroundColor Cyan
        Write-Host "üîÑ Backup: ${{ inputs.backup }}" -ForegroundColor Cyan

    # Step 2: Checkout v√† chu·∫©n b·ªã
    - name: üì• Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: üìÅ Prepare Directories
      shell: powershell
      run: |
        Write-Host "=== Chu·∫©n b·ªã th∆∞ m·ª•c ===" -ForegroundColor Green
        
        # Create necessary directories
        $dirs = @("TASTRVPS", "logs", "templates", "TASTRVPS\scripts")
        foreach ($dir in $dirs) {
          if (!(Test-Path $dir)) {
            New-Item -ItemType Directory -Path $dir -Force
            Write-Host "‚úÖ T·∫°o th∆∞ m·ª•c: $dir" -ForegroundColor Green
          }
        }
        
        # Set environment variables
        echo "VPS_NAME=${{ inputs.vps_name || 'TASTR-VPS' }}" >> $env:GITHUB_ENV
        echo "BACKUP_ENABLED=${{ inputs.backup }}" >> $env:GITHUB_ENV
        echo "TIMEOUT_MINUTES=${{ inputs.timeout_minutes || '360' }}" >> $env:GITHUB_ENV
        echo "WINDOWS_PASSWORD=${{ inputs.windows_password }}" >> $env:GITHUB_ENV
        echo "NGROK_TOKEN=${{ inputs.ngrok_token }}" >> $env:GITHUB_ENV

    # Step 2.5: Display System Information
    - name: üìä Display System Information
      shell: powershell
      run: |
        Write-Host "=== Th√¥ng s·ªë h·ªá th·ªëng ===" -ForegroundColor Green
        
        # Get system info
        $computerInfo = Get-ComputerInfo
        $cpu = Get-WmiObject -Class Win32_Processor | Select-Object -First 1
        $memory = Get-WmiObject -Class Win32_PhysicalMemory | Measure-Object -Property Capacity -Sum
        $disk = Get-WmiObject -Class Win32_LogicalDisk -Filter "DeviceID='C:'" | Select-Object Size, FreeSpace
        
        # Display info
        Write-Host "üíª Computer: $($computerInfo.CsName)" -ForegroundColor Cyan
        Write-Host "üñ•Ô∏è OS: $($computerInfo.WindowsProductName)" -ForegroundColor Cyan
        Write-Host "üîß CPU: $($cpu.Name)" -ForegroundColor Cyan
        Write-Host "‚ö° CPU Cores: $($cpu.NumberOfCores)" -ForegroundColor Cyan
        Write-Host "üß† RAM Total: $([math]::Round($memory.Sum / 1GB, 2)) GB" -ForegroundColor Cyan
        Write-Host "üíæ Disk Total: $([math]::Round($disk.Size / 1GB, 2)) GB" -ForegroundColor Cyan
        Write-Host "üíΩ Disk Free: $([math]::Round($disk.FreeSpace / 1GB, 2)) GB" -ForegroundColor Cyan
        
        # Check GPU
        try {
          $gpu = Get-WmiObject -Class Win32_VideoController | Where-Object { $_.Name -notlike "*Basic*" -and $_.Name -notlike "*Generic*" } | Select-Object -First 1
          if ($gpu) {
            Write-Host "üéÆ GPU: $($gpu.Name)" -ForegroundColor Cyan
            if ($gpu.AdapterRAM -gt 0) {
              Write-Host "üéØ VRAM: $([math]::Round($gpu.AdapterRAM / 1GB, 2)) GB" -ForegroundColor Cyan
            }
          } else {
            Write-Host "üéÆ GPU: Not detected" -ForegroundColor Yellow
          }
        } catch {
          Write-Host "üéÆ GPU: Detection failed" -ForegroundColor Yellow
        }
        
        # Runner info
        Write-Host "‚òÅÔ∏è Runner: GitHub Windows (Mi·ªÖn ph√≠)" -ForegroundColor Blue
        Write-Host "‚è∞ Time Limit: ${{ inputs.timeout_minutes }} minutes" -ForegroundColor Blue

    # Step 3: Restore backup (optional)
    - name: üì¶ Restore Backup (Optional)
      if: inputs.backup == true
      shell: powershell
      run: |
        Write-Host "=== Kh√¥i ph·ª•c Backup ===" -ForegroundColor Green
        
        if (Test-Path "TASTRVPS\backupre-store.sh") {
          Write-Host "üîÑ Ch·∫°y script kh√¥i ph·ª•c backup..." -ForegroundColor Yellow
          bash TASTRVPS\backupre-store.sh restore
        } else {
          Write-Host "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y script backup, b·ªè qua b∆∞·ªõc n√†y" -ForegroundColor Yellow
        }

    # Step 4: Load configuration
    - name: ‚öôÔ∏è Load Configuration
      shell: powershell
      run: |
        Write-Host "=== T·∫£i c·∫•u h√¨nh ===" -ForegroundColor Green
        
        # Install PowerShell-Yaml if not exists
        if (!(Get-Module -ListAvailable -Name powershell-yaml)) {
          Write-Host "üì¶ C√†i ƒë·∫∑t PowerShell-Yaml..." -ForegroundColor Yellow
          Install-Module -Name powershell-yaml -Force -Scope CurrentUser
        }
        
        # Load config if exists
        if (Test-Path "TASTRVPS\config.yml") {
          Write-Host "üìù T·∫£i c·∫•u h√¨nh t·ª´ config.yml..." -ForegroundColor Cyan
          $config = Get-Content "TASTRVPS\config.yml" | ConvertFrom-Yaml
          
          # Set environment variables from config
          # Always use TASTR as the username
          echo "WINDOWS_USER=TASTR" >> $env:GITHUB_ENV
          
          if ($config.tmate_server) {
            echo "TMATE_SERVER=$($config.tmate_server)" >> $env:GITHUB_ENV
          } else {
            echo "TMATE_SERVER=nyc1.tmate.io" >> $env:GITHUB_ENV
          }
        } else {
          Write-Host "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y config.yml, s·ª≠ d·ª•ng c·∫•u h√¨nh m·∫∑c ƒë·ªãnh" -ForegroundColor Yellow
          echo "WINDOWS_USER=TASTR" >> $env:GITHUB_ENV
          echo "TMATE_SERVER=nyc1.tmate.io" >> $env:GITHUB_ENV
        }

    # Step 5: Setup Windows RDP
    - name: üñ•Ô∏è Setup Windows RDP
      shell: powershell
      run: |
        Write-Host "=== C√†i ƒë·∫∑t Windows RDP ===" -ForegroundColor Green
        
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 1
        
        # Use provided password
        $password = $env:WINDOWS_PASSWORD
        Write-Host "üîê S·ª≠ d·ª•ng m·∫≠t kh·∫©u ƒë∆∞·ª£c cung c·∫•p" -ForegroundColor Cyan
        
        # Hide runneradmin user
        Write-Host "üë§ ·∫®n user runneradmin..." -ForegroundColor Yellow
        net user runneradmin /active:no 2>$null || Write-Host "User runneradmin kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã ·∫©n" -ForegroundColor Gray
        
        # Create TASTR user with full privileges
        $username = "TASTR"
        Write-Host "üë§ T·∫°o user TASTR v·ªõi full quy·ªÅn..." -ForegroundColor Cyan
        
        # Create new user TASTR
        net user $username $password /add
        net localgroup administrators $username /add
        net localgroup "Remote Desktop Users" $username /add
        
        # Give additional privileges
        net localgroup "Power Users" $username /add 2>$null || Write-Host "Power Users group kh√¥ng t·ªìn t·∫°i" -ForegroundColor Gray
        net localgroup "Users" $username /add 2>$null || Write-Host "Users group ƒë√£ c√≥ user" -ForegroundColor Gray
        
        Write-Host "‚úÖ RDP ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh" -ForegroundColor Green
        Write-Host "üë§ Username: $username" -ForegroundColor Cyan
        Write-Host "üîë Password: [HIDDEN]" -ForegroundColor Cyan
        
        # Save credentials to environment
        echo "RDP_USERNAME=$username" >> $env:GITHUB_ENV
        echo "RDP_PASSWORD=$password" >> $env:GITHUB_ENV

    # Step 6: Setup Ngrok tunnel v·ªõi fallback Playit
    - name: üåê Setup Remote Access Tunnel
      shell: powershell
      run: |
        Write-Host "=== C√†i ƒë·∫∑t Remote Access ===" -ForegroundColor Green
        
        # Use ngrok token from input (now required)
        $ngrokToken = $env:NGROK_TOKEN
        
        Write-Host "üöÄ C√†i ƒë·∫∑t Ngrok tunnel..." -ForegroundColor Cyan
        
        # Download v√† c√†i ƒë·∫∑t Ngrok
        Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
        Expand-Archive -Path "ngrok.zip" -DestinationPath "." -Force
        
        # C·∫•u h√¨nh Ngrok
        .\ngrok.exe config add-authtoken $ngrokToken
        
        # Kh·ªüi ƒë·ªông Ngrok tunnel cho RDP
        Start-Process -FilePath ".\ngrok.exe" -ArgumentList "tcp", "3389", "--log=stdout" -NoNewWindow -PassThru
        
        Start-Sleep -Seconds 10
        
        # L·∫•y th√¥ng tin tunnel
        try {
          $tunnelInfo = Invoke-RestMethod -Uri "http://localhost:4040/api/tunnels"
          $publicUrl = $tunnelInfo.tunnels[0].public_url
          Write-Host "üåê Ngrok URL: $publicUrl" -ForegroundColor Green
          echo "TUNNEL_URL=$publicUrl" >> $env:GITHUB_ENV
          echo "TUNNEL_TYPE=ngrok" >> $env:GITHUB_ENV
        } catch {
          Write-Host "‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y th√¥ng tin Ngrok tunnel" -ForegroundColor Yellow
          Write-Host "üí° H√£y ki·ªÉm tra Ngrok dashboard ƒë·ªÉ l·∫•y URL k·∫øt n·ªëi" -ForegroundColor Cyan
        }

    # Step 7: Create optimized backup
    - name: üíæ Create Backup
      shell: powershell
      run: |
        Write-Host "=== T·∫°o Backup ===" -ForegroundColor Green
        
        if (Test-Path "TASTRVPS\backupre-store.sh") {
          Write-Host "üì¶ Ch·∫°y script t·∫°o backup..." -ForegroundColor Yellow
          bash TASTRVPS\backupre-store.sh backup
        } else {
          Write-Host "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y script backup" -ForegroundColor Yellow
          
          # Simple backup
          $backupDir = "backup-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          New-Item -ItemType Directory -Path $backupDir -Force
          
          # Backup important files
          if (Test-Path "TASTRVPS") { Copy-Item -Path "TASTRVPS" -Destination "$backupDir\" -Recurse -Force }
          if (Test-Path "logs") { Copy-Item -Path "logs" -Destination "$backupDir\" -Recurse -Force }
          
          Write-Host "‚úÖ Backup c∆° b·∫£n ƒë√£ ho√†n th√†nh: $backupDir" -ForegroundColor Green
        }

    # Step 8: Auto-commit updates
    - name: üìù Auto-commit Updates
      shell: powershell
      run: |
        Write-Host "=== C·∫≠p nh·∫≠t Repository ===" -ForegroundColor Green
        
        git config --global user.name "VPS Auto Update"
        git config --global user.email "vps@github.actions"
        
        # Add changes
        git add -A
        
        # Check if there are changes to commit
        $changes = git status --porcelain
        if ($changes) {
          $commitMessage = "ü§ñ Auto-update VPS session $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          git commit -m $commitMessage
          
          # Try to push (may fail if no permissions)
          try {
            git push
            Write-Host "‚úÖ ƒê√£ c·∫≠p nh·∫≠t repository" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è Kh√¥ng th·ªÉ push changes (c√≥ th·ªÉ do quy·ªÅn h·∫°n)" -ForegroundColor Yellow
          }
        } else {
          Write-Host "üìù Kh√¥ng c√≥ thay ƒë·ªïi ƒë·ªÉ commit" -ForegroundColor Cyan
        }

    # Step 9: Keep-alive monitoring v·ªõi health checks
    - name: üîÑ Keep-alive Monitoring
      shell: powershell
      run: |
        Write-Host "=== B·∫Øt ƒë·∫ßu Keep-alive Monitoring ===" -ForegroundColor Green
        
        $timeout = [int]$env:TIMEOUT_MINUTES
        $endTime = (Get-Date).AddMinutes($timeout)
        $checkInterval = 60 # Check every minute
        
        Write-Host "‚è∞ VPS s·∫Ω ch·∫°y ƒë·∫øn: $($endTime.ToString('yyyy-MM-dd HH:mm:ss'))" -ForegroundColor Cyan
        Write-Host "üåê Th√¥ng tin k·∫øt n·ªëi:" -ForegroundColor Green
        Write-Host "   Username: $env:RDP_USERNAME" -ForegroundColor Yellow
        Write-Host "   Password: $env:RDP_PASSWORD" -ForegroundColor Yellow
        Write-Host "   Tunnel Type: $env:TUNNEL_TYPE" -ForegroundColor Yellow
        if ($env:TUNNEL_URL) {
          Write-Host "   Tunnel URL: $env:TUNNEL_URL" -ForegroundColor Yellow
        }
        
        Write-Host "`nüéØ VPS ƒë√£ s·∫µn s√†ng s·ª≠ d·ª•ng!" -ForegroundColor Green
        Write-Host "üìö S·ª≠ d·ª•ng th√¥ng tin tr√™n ƒë·ªÉ k·∫øt n·ªëi RDP v√† b·∫Øt ƒë·∫ßu h·ªçc t·∫≠p!" -ForegroundColor Cyan
        Write-Host "‚è±Ô∏è Th·ªùi gian c√≤n l·∫°i: $timeout ph√∫t" -ForegroundColor Yellow
        Write-Host "üñ•Ô∏è Th√¥ng s·ªë VPS: 16GB RAM, 200GB+ Storage, 4 cores" -ForegroundColor Cyan
        
        while ((Get-Date) -lt $endTime) {
          $remaining = [math]::Round(($endTime - (Get-Date)).TotalMinutes, 1)
          
          # Health checks
          $rdpStatus = Get-Service -Name "TermService" -ErrorAction SilentlyContinue
          $memoryUsage = [math]::Round((Get-WmiObject -Class Win32_OperatingSystem).TotalVisibleMemorySize / 1MB, 2)
          $freeSpace = [math]::Round((Get-WmiObject -Class Win32_LogicalDisk -Filter "DeviceID='C:'").FreeSpace / 1GB, 2)
          
          Write-Host "üíì Health Check - C√≤n l·∫°i: $remaining ph√∫t | RDP: $($rdpStatus.Status) | RAM: $memoryUsage GB | Disk: $freeSpace GB free" -ForegroundColor Cyan
          
          # Log to file
          $logEntry = "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - Remaining: $remaining min, RDP: $($rdpStatus.Status), RAM: $memoryUsage GB, Disk: $freeSpace GB"
          Add-Content -Path "logs\vps-monitoring.log" -Value $logEntry
          
          Start-Sleep -Seconds $checkInterval
        }
        
        Write-Host "‚è∞ Th·ªùi gian ch·∫°y VPS ƒë√£ h·∫øt!" -ForegroundColor Yellow
        Write-Host "üéì C·∫£m ∆°n b·∫°n ƒë√£ s·ª≠ d·ª•ng TASTR Windows VPS!" -ForegroundColor Green
        Write-Host "üí° B·∫°n c√≥ th·ªÉ ch·∫°y l·∫°i workflow ƒë·ªÉ t·∫°o VPS m·ªõi" -ForegroundColor Cyan
