name: DVTA

on:
  workflow_dispatch:
    inputs:
      runtime_minutes:
        description: 'Nhập thời gian chạy (phút). Tối đa 355 để có 5 phút dự phòng.'
        required: true
        default: '120'
        type: string

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      # GỢI Ý 11: CACHE CÁC GÓI CÀI ĐẶT CHO NHANH HƠN
      - name: Cache Chocolatey packages
        uses: actions/cache@v4
        with:
          path: C:\ProgramData\chocolatey\lib
          key: ${{ runner.os }}-choco-v1-${{ hashFiles('**/windows-build.yml') }}

      - name: Setup RDP with Data Sync & Caching
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          # Thêm secret của Rclone vào đây
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
          RUNTIME: ${{ github.event.inputs.runtime_minutes }}
        shell: pwsh
        run: |
          # == PHẦN 1: TẠO USER VÀ CÀI ĐẶT PHẦN MỀM CẦN THIẾT ==
          $char_set = ('a'..'z') + ('A'..'Z') + ('0'..'9')
          $Password = -join ($char_set | Get-Random -Count 14)
          $User = "TASTR"
          net user $User $Password /add /expires:never /passwordchg:no
          net localgroup Administrators $User /add
          net localgroup "Remote Desktop Users" $User /add
          net user runneradmin /active:no
          
          # Cài đặt Rclone bằng Chocolatey
          choco install rclone -y --force
          
          # == PHẦN 2: KÍCH HOẠT RDP VÀ TỐI ƯU HÓA ==
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # == GỢI Ý 10: ĐỒNG BỘ DỮ LIỆU TỪ CLOUD VỀ MÁY ẢO ==
          # Tạo lại file cấu hình Rclone từ secret
          New-Item -Path "C:\Users\TASTR\.config\rclone" -ItemType Directory -Force
          Set-Content -Path "C:\Users\TASTR\.config\rclone\rclone.conf" -Value $env:RCLONE_CONF
          
          # TẠO THƯ MỤC LÀM VIỆC
          New-Item -Path "C:\Users\TASTR\Desktop\Project" -ItemType Directory -Force
          
          Write-Host "✅ Đang đồng bộ dữ liệu từ Cloud về máy ảo..."
          # THAY ĐỔI "gdrive:Project" cho đúng với cấu hình của bạn
          # "gdrive" là tên remote bạn đặt ở Bước 1. "Project" là tên thư mục trên cloud.
          rclone sync "gdrive:Project" "C:\Users\TASTR\Desktop\Project" --progress
          
          # == PHẦN 3: CHẠY NGROK VÀ IN THÔNG TIN ==
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile "ngrok.zip"
          Expand-Archive ngrok.zip
          ./ngrok/ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          Start-Process -FilePath "./ngrok/ngrok.exe" -ArgumentList "tcp 3389 --log=stdout --region ap" -WindowStyle Hidden
          Start-Sleep -Seconds 8
          
          $public_url = (Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels").tunnels[0].public_url
          Write-Host "====================== RDP Info ======================"
          Write-Host "        USER: $User"
          Write-Host "    PASSWORD: $Password"
          Write-Host "     ADDRESS: $public_url"
          Write-Host "======================================================"

          # == PHẦN 4: ĐẾM NGƯỢC VÀ TỰ ĐỘNG TẮT ==
          $startTime = Get-Date
          $maxMinutes = [int]$env:RUNTIME
          while (((Get-Date) - $startTime).TotalMinutes -lt $maxMinutes) {
              $remainingMinutes = [math]::Round($maxMinutes - ((Get-Date) - $startTime).TotalMinutes, 1)
              Write-Host "⏳ Thời gian còn lại: ${remainingMinutes} phút..."
              Start-Sleep -Seconds 60
          }
          
          # == GỢI Ý 10: ĐỒNG BỘ DỮ LIỆU TỪ MÁY ẢO LÊN CLOUD TRƯỚC KHI TẮT ==
          Write-Host "⌛ Hết giờ! Đang đồng bộ dữ liệu lên Cloud trước khi ngắt kết nối..."
          # THAY ĐỔI "gdrive:Project" cho đúng với cấu hình của bạn
          rclone sync "C:\Users\TASTR\Desktop\Project" "gdrive:Project" --progress
          
          Write-Host "✅ Đồng bộ hoàn tất. Ngắt kết nối Ngrok..."
          try { Stop-Process -Name "ngrok" -Force } catch {}
