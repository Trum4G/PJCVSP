name: Windows VM for Learning and Projects

on:
  workflow_dispatch:
    inputs:
      vm_type:
        description: 'Loáº¡i mÃ¡y áº£o Windows'
        required: true
        default: 'windows-latest'
        type: choice
        options:
        - windows-latest
        - windows-2022
        - windows-2019
      setup_tools:
        description: 'CÃ i Ä‘áº·t cÃ´ng cá»¥ phÃ¡t triá»ƒn'
        required: true
        default: true
        type: boolean
      setup_database:
        description: 'CÃ i Ä‘áº·t cÆ¡ sá»Ÿ dá»¯ liá»‡u local'
        required: true
        default: true
        type: boolean
      run_time_minutes:
        description: 'Thá»i gian cháº¡y mÃ¡y áº£o (phÃºt) - Tá»‘i Ä‘a 360 phÃºt'
        required: true
        default: '360'
        type: string
      ngrok_authtoken:
        description: 'Ngrok Authtoken (Ä‘á»ƒ giá»¯ mÃ¡y áº£o luÃ´n live)'
        required: false
        default: ''
        type: string

jobs:
  setup-windows-vm:
    runs-on: ${{ github.event.inputs.vm_type }}
    timeout-minutes: ${{ github.event.inputs.run_time_minutes || 360 }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Hiá»ƒn thá»‹ thÃ´ng tin há»‡ thá»‘ng
      run: |
        echo "=== ThÃ´ng tin há»‡ thá»‘ng ==="
        systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"
        echo "=== ThÃ´ng tin CPU ==="
        wmic cpu get name,numberofcores
        echo "=== ThÃ´ng tin RAM ==="
        wmic computersystem get TotalPhysicalMemory
        echo "=== ThÃ´ng tin á»• cá»©ng ==="
        wmic logicaldisk get size,freespace,caption
        echo "=== Thá»i gian cháº¡y ==="
        echo "Thá»i gian cháº¡y: ${{ github.event.inputs.run_time_minutes }} phÃºt"
        
    - name: CÃ i Ä‘áº·t Chocolatey (Package Manager)
      if: ${{ github.event.inputs.setup_tools }}
      run: |
        Set-ExecutionPolicy Bypass -Scope Process -Force
        [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
        iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
        
    - name: CÃ i Ä‘áº·t cÃ´ng cá»¥ phÃ¡t triá»ƒn
      if: ${{ github.event.inputs.setup_tools }}
      run: |
        choco install -y git nodejs python visualstudio2022buildtools
        choco install -y vscode notepadplusplus
        choco install -y postman insomnia
        choco install -y docker-desktop
        choco install -y mysql postgresql sqlite
        
    - name: CÃ i Ä‘áº·t cÆ¡ sá»Ÿ dá»¯ liá»‡u local
      if: ${{ github.event.inputs.setup_database }}
      run: |
        # CÃ i Ä‘áº·t SQLite (Ä‘Ã£ cÃ³ sáºµn)
        echo "SQLite Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t"
        
        # CÃ i Ä‘áº·t MySQL
        choco install -y mysql
        net start mysql
        
        # CÃ i Ä‘áº·t PostgreSQL
        choco install -y postgresql
        net start postgresql-x64-15
        
    - name: CÃ i Ä‘áº·t cÃ¡c ngÃ´n ngá»¯ láº­p trÃ¬nh
      if: ${{ github.event.inputs.setup_tools }}
      run: |
        # CÃ i Ä‘áº·t Java
        choco install -y openjdk11
        
        # CÃ i Ä‘áº·t .NET
        choco install -y dotnet-sdk
        
        # CÃ i Ä‘áº·t Go
        choco install -y golang
        
        # CÃ i Ä‘áº·t Rust
        choco install -y rust
        
    - name: CÃ i Ä‘áº·t cÃ¡c framework vÃ  thÆ° viá»‡n
      if: ${{ github.event.inputs.setup_tools }}
      run: |
        # CÃ i Ä‘áº·t cÃ¡c framework web
        npm install -g express-generator
        npm install -g @angular/cli
        npm install -g @vue/cli
        npm install -g create-react-app
        
        # CÃ i Ä‘áº·t cÃ¡c cÃ´ng cá»¥ Python
        pip install django flask fastapi
        pip install jupyter notebook
        pip install pandas numpy matplotlib
        
    - name: CÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh Ngrok
      if: ${{ github.event.inputs.ngrok_authtoken != '' }}
      run: |
        # CÃ i Ä‘áº·t Ngrok
        choco install -y ngrok
        
        # Cáº¥u hÃ¬nh Ngrok authtoken
        ngrok config add-authtoken ${{ github.event.inputs.ngrok_authtoken }}
        
        # Táº¡o file cáº¥u hÃ¬nh Ngrok
        $ngrokConfig = @"
        version: "2"
        authtoken: ${{ github.event.inputs.ngrok_authtoken }}
        tunnels:
          ssh:
            proto: tcp
            addr: 22
          rdp:
            proto: tcp
            addr: 3389
          web:
            proto: http
            addr: 3000
          api:
            proto: http
            addr: 8000
        "@
        
        $ngrokConfig | Out-File -FilePath "$env:USERPROFILE\.ngrok2\ngrok.yml" -Encoding UTF8
        
        echo "Ngrok Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh vá»›i authtoken"
        
    - name: Táº¡o thÆ° má»¥c dá»± Ã¡n
      run: |
        mkdir C:\Projects
        mkdir C:\Projects\Learning
        mkdir C:\Projects\School
        mkdir C:\Projects\Personal
        
    - name: Táº¡o file README cho dá»± Ã¡n
      run: |
        @"
        # Windows VM Environment
        
        ## ThÃ´ng tin há»‡ thá»‘ng
        - OS: Windows Server 2022
        - ÄÆ°á»£c táº¡o bá»Ÿi: GitHub Actions
        - Má»¥c Ä‘Ã­ch: Há»c táº­p vÃ  lÃ m Ä‘á»“ Ã¡n
        - Thá»i gian cháº¡y: ${{ github.event.inputs.run_time_minutes }} phÃºt
        - Ngrok: ${{ github.event.inputs.ngrok_authtoken != '' && 'ÄÃ£ cáº¥u hÃ¬nh' || 'ChÆ°a cáº¥u hÃ¬nh' }}
        
        ## CÃ´ng cá»¥ Ä‘Ã£ cÃ i Ä‘áº·t
        - Git
        - Node.js
        - Python
        - Visual Studio Build Tools
        - VS Code
        - Docker Desktop
        - MySQL
        - PostgreSQL
        - SQLite
        ${{ github.event.inputs.ngrok_authtoken != '' && '- Ngrok (Ä‘Ã£ cáº¥u hÃ¬nh)' || '' }}
        
        ## NgÃ´n ngá»¯ láº­p trÃ¬nh
        - Java (OpenJDK 11)
        - .NET
        - Go
        - Rust
        
        ## Framework
        - Express.js
        - Angular
        - Vue.js
        - React
        - Django
        - Flask
        - FastAPI
        
        ## ThÆ° má»¥c dá»± Ã¡n
        - C:\Projects\Learning - Cho viá»‡c há»c táº­p
        - C:\Projects\School - Cho Ä‘á»“ Ã¡n trÆ°á»ng
        - C:\Projects\Personal - Cho dá»± Ã¡n cÃ¡ nhÃ¢n
        
        ## Sá»­ dá»¥ng
        1. Clone repository vá» mÃ¡y
        2. Má»Ÿ VS Code
        3. Báº¯t Ä‘áº§u coding!
        
        ## Ngrok (náº¿u Ä‘Ã£ cáº¥u hÃ¬nh)
        ${{ github.event.inputs.ngrok_authtoken != '' && 'Äá»ƒ káº¿t ná»‘i tá»« bÃªn ngoÃ i:' || '' }}
        ${{ github.event.inputs.ngrok_authtoken != '' && '- SSH: ngrok tcp 22' || '' }}
        ${{ github.event.inputs.ngrok_authtoken != '' && '- RDP: ngrok tcp 3389' || '' }}
        ${{ github.event.inputs.ngrok_authtoken != '' && '- Web: ngrok http 3000' || '' }}
        ${{ github.event.inputs.ngrok_authtoken != '' && '- API: ngrok http 8000' || '' }}
        
        ## LÆ°u Ã½
        - MÃ¡y áº£o nÃ y sáº½ tá»± Ä‘á»™ng há»§y sau ${{ github.event.inputs.run_time_minutes }} phÃºt
        - Äá»ƒ lÆ°u trá»¯ dá»¯ liá»‡u, hÃ£y commit vÃ  push code lÃªn GitHub
        "@ | Out-File -FilePath "C:\Projects\README.md" -Encoding UTF8
        
    - name: Táº¡o script khá»Ÿi Ä‘á»™ng Ngrok
      if: ${{ github.event.inputs.ngrok_authtoken != '' }}
      run: |
        $ngrokScript = @"
        @echo off
        echo Starting Ngrok tunnels...
        
        REM Start SSH tunnel
        start "Ngrok SSH" ngrok tcp 22
        
        REM Start RDP tunnel  
        start "Ngrok RDP" ngrok tcp 3389
        
        REM Start web tunnel
        start "Ngrok Web" ngrok http 3000
        
        REM Start API tunnel
        start "Ngrok API" ngrok http 8000
        
        echo Ngrok tunnels started!
        echo Check ngrok status at: http://localhost:4040
        "@
        
        $ngrokScript | Out-File -FilePath "C:\Projects\start-ngrok.bat" -Encoding ASCII
        
    - name: Hiá»ƒn thá»‹ thÃ´ng tin cÃ i Ä‘áº·t
      run: |
        echo "=== CÃ´ng cá»¥ Ä‘Ã£ cÃ i Ä‘áº·t ==="
        git --version
        node --version
        python --version
        java -version
        dotnet --version
        go version
        rustc --version
        
        echo "=== Database services ==="
        sc query mysql
        sc query postgresql-x64-15
        
        echo "=== Ngrok status ==="
        ${{ github.event.inputs.ngrok_authtoken != '' && 'ngrok version' || 'echo "Ngrok not configured"' }}
        
        echo "=== ThÆ° má»¥c dá»± Ã¡n ==="
        dir C:\Projects
        
    - name: Táº¡o artifact vá»›i thÃ´ng tin mÃ´i trÆ°á»ng
      run: |
        $envInfo = @"
        # ThÃ´ng tin mÃ´i trÆ°á»ng Windows VM
        NgÃ y táº¡o: $(Get-Date)
        OS: $env:OS
        Architecture: $env:PROCESSOR_ARCHITECTURE
        Username: $env:USERNAME
        Computer Name: $env:COMPUTERNAME
        Thá»i gian cháº¡y: ${{ github.event.inputs.run_time_minutes }} phÃºt
        Ngrok: ${{ github.event.inputs.ngrok_authtoken != '' && 'ÄÃ£ cáº¥u hÃ¬nh' || 'ChÆ°a cáº¥u hÃ¬nh' }}
        
        ## CÃ´ng cá»¥ Ä‘Ã£ cÃ i Ä‘áº·t:
        - Git: $(git --version 2>$null)
        - Node.js: $(node --version 2>$null)
        - Python: $(python --version 2>$null)
        - Java: $(java -version 2>&1 | Select-Object -First 1)
        - .NET: $(dotnet --version 2>$null)
        - Go: $(go version 2>$null)
        - Rust: $(rustc --version 2>$null)
        ${{ github.event.inputs.ngrok_authtoken != '' && '- Ngrok: $(ngrok version 2>$null)' || '' }}
        
        ## ThÆ° má»¥c dá»± Ã¡n:
        - C:\Projects\Learning
        - C:\Projects\School  
        - C:\Projects\Personal
        
        ## HÆ°á»›ng dáº«n sá»­ dá»¥ng:
        1. Má»Ÿ VS Code: code C:\Projects
        2. Táº¡o dá»± Ã¡n má»›i trong thÆ° má»¥c phÃ¹ há»£p
        3. Sá»­ dá»¥ng Git Ä‘á»ƒ quáº£n lÃ½ version
        4. Commit vÃ  push code thÆ°á»ng xuyÃªn
        ${{ github.event.inputs.ngrok_authtoken != '' && '5. Cháº¡y C:\Projects\start-ngrok.bat Ä‘á»ƒ khá»Ÿi Ä‘á»™ng tunnels' || '' }}
        "@
        
        $envInfo | Out-File -FilePath "environment-info.md" -Encoding UTF8
        
    - name: Upload environment info
      uses: actions/upload-artifact@v4
      with:
        name: windows-vm-info
        path: environment-info.md
        retention-days: 30
        
    - name: ThÃ´ng bÃ¡o hoÃ n thÃ nh
      run: |
        echo "ğŸ‰ MÃ¡y áº£o Windows Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p thÃ nh cÃ´ng!"
        echo "ğŸ“ ThÆ° má»¥c dá»± Ã¡n: C:\Projects"
        echo "ğŸ› ï¸ CÃ¡c cÃ´ng cá»¥ phÃ¡t triá»ƒn Ä‘Ã£ sáºµn sÃ ng"
        echo "ğŸ’¾ Database local Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t"
        echo "â° Thá»i gian cháº¡y: ${{ github.event.inputs.run_time_minutes }} phÃºt"
        ${{ github.event.inputs.ngrok_authtoken != '' && 'echo "ğŸŒ Ngrok Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ giá»¯ mÃ¡y áº£o luÃ´n live"' || '' }}
        echo "ğŸš€ Báº¯t Ä‘áº§u coding ngay bÃ¢y giá»!"
        
    - name: Giá»¯ mÃ¡y áº£o live vá»›i Ngrok
      if: ${{ github.event.inputs.ngrok_authtoken != '' }}
      run: |
        echo "Khá»Ÿi Ä‘á»™ng Ngrok Ä‘á»ƒ giá»¯ mÃ¡y áº£o luÃ´n live..."
        
        # Khá»Ÿi Ä‘á»™ng Ngrok tunnels
        Start-Process -FilePath "ngrok" -ArgumentList "tcp", "22" -WindowStyle Minimized
        Start-Process -FilePath "ngrok" -ArgumentList "tcp", "3389" -WindowStyle Minimized
        Start-Process -FilePath "ngrok" -ArgumentList "http", "3000" -WindowStyle Minimized
        Start-Process -FilePath "ngrok" -ArgumentList "http", "8000" -WindowStyle Minimized
        
        # Hiá»ƒn thá»‹ thÃ´ng tin káº¿t ná»‘i
        Start-Sleep -Seconds 5
        echo "=== Ngrok Tunnels ==="
        echo "SSH: $(ngrok api tunnels list | ConvertFrom-Json | Where-Object {$_.config.addr -eq 'localhost:22'} | Select-Object -ExpandProperty public_url)"
        echo "RDP: $(ngrok api tunnels list | ConvertFrom-Json | Where-Object {$_.config.addr -eq 'localhost:3389'} | Select-Object -ExpandProperty public_url)"
        echo "Web: $(ngrok api tunnels list | ConvertFrom-Json | Where-Object {$_.config.addr -eq 'localhost:3000'} | Select-Object -ExpandProperty public_url)"
        echo "API: $(ngrok api tunnels list | ConvertFrom-Json | Where-Object {$_.config.addr -eq 'localhost:8000'} | Select-Object -ExpandProperty public_url)"
        
        echo "Ngrok Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi Ä‘á»™ng Ä‘á»ƒ giá»¯ mÃ¡y áº£o luÃ´n live!"
        echo "Kiá»ƒm tra tráº¡ng thÃ¡i táº¡i: http://localhost:4040"
